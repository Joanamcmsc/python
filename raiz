# Instalar a biblioteca stripe e python-telegram-bot se necessÃ¡rio (para notebooks como Colab ou Jupyter)
!pip install stripe
!pip install python-telegram-bot

import nest_asyncio
import asyncio
from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update
from telegram.constants import ParseMode  # Atualizado
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
import stripe
import random

# Permitir que o loop de eventos existente funcione em Colab
nest_asyncio.apply()

# Links diretos para os produtos no Stripe
links_stripe = {
    '3_cartas': 'https://buy.stripe.com/4gw5le7Osa9i7IcdQQ',  # R$ 19,90
    '6_cartas': 'https://buy.stripe.com/9AQ5lec4Idlu7IcfYZ',  # R$ 24,90
    '3_perguntas_oraculo': 'https://buy.stripe.com/9AQ6pic4Ia9iaUofZ3',  # R$ 29,90
    '12_cartas': 'https://buy.stripe.com/cN26piecQ4OYd2w7su',  # R$ 34,90
    'tarot_amor_completo': 'https://buy.stripe.com/aEU9Bu4Cg6X66E828c',  # R$ 49,90
    '21_cartas': 'https://buy.stripe.com/4gw292gkY81ae6A7sv',  # R$ 49,90
    '10_perguntas_oraculo': 'https://buy.stripe.com/7sIaFy2u82GQ5A49AG',  # R$ 59,90
}

# Cupom de desconto vÃ¡lido
VALID_COUPON = 'PROMO50'

# VariÃ¡vel global para armazenar o cupom temporariamente
temp_coupon = {}

# Definindo o baralho de tarot com as cartas adicionadas
tarot_deck = {
    'O Louco': 'ğŸŒŸ O comeÃ§o de uma jornada, aventura e espontaneidade.',
    'O Mago': 'ğŸ§™ Habilidade, poder e a capacidade de manifestar desejos.',
    'A Sacerdotisa': 'ğŸ”® IntuiÃ§Ã£o, mistÃ©rio e sabedoria secreta.',
    'A Imperatriz': 'ğŸŒ¼ Fertilidade, abundÃ¢ncia e criatividade.',
    'O Imperador': 'ğŸ‘‘ Autoridade, estrutura e controle.',
    'O Papa': 'ğŸ“œ TradiÃ§Ã£o, conformidade e moralidade.',
    'Os Enamorados': 'ğŸ’‘ Amor, uniÃ£o e escolhas.',
    'O Carro': 'ğŸš— DeterminaÃ§Ã£o, sucesso e controle.',
    'A JustiÃ§a': 'âš–ï¸ EquilÃ­brio, justiÃ§a e responsabilidade.',
    'O Eremita': 'ğŸ”¦ ReflexÃ£o, introspecÃ§Ã£o e sabedoria interior.',
    'A Roda da Fortuna': 'ğŸ¡ MudanÃ§a, sorte e ciclos.',
    'A ForÃ§a': 'ğŸ¦ Coragem, controle e compaixÃ£o.',
    'O Enforcado': 'ğŸ”„ SacrifÃ­cio, novas perspectivas e rendiÃ§Ã£o.',
    'A Morte': 'â˜ ï¸ TransformaÃ§Ã£o, fim de ciclos e novos comeÃ§os.',
    'A TemperanÃ§a': 'âš—ï¸ EquilÃ­brio, moderaÃ§Ã£o e paciÃªncia.',
    'O Diabo': 'ğŸ˜ˆ TentaÃ§Ã£o, materialismo e excessos.',
    'A Torre': 'âš¡ MudanÃ§a sÃºbita, crise e revelaÃ§Ãµes.',
    'A Estrela': 'âœ¨ EsperanÃ§a, inspiraÃ§Ã£o e serenidade.',
    'A Lua': 'ğŸŒ™ IlusÃµes, medo e intuiÃ§Ã£o.',
    'O Sol': 'â˜€ï¸ Felicidade, sucesso e vitalidade.',
    'O Julgamento': 'ğŸº RenovaÃ§Ã£o, decisÃ£o e despertar.',
    'O Mundo': 'ğŸŒ ConclusÃ£o, realizaÃ§Ã£o e integraÃ§Ã£o.'
}

# FunÃ§Ã£o para escolher cartas aleatÃ³rias do deck
def choose_cards(deck, num_cards=3):
    return random.sample(list(deck.keys()), num_cards)

# FunÃ§Ã£o para interpretar as cartas escolhidas
def interpret_cards(selected_cards, deck):
    interpretation = "<b>ğŸ”® Sua leitura personalizada:</b>\n\n"
    for card in selected_cards:
        interpretation += f"<b>{card}:</b> {deck[card]}\n\n"
    return interpretation

# FunÃ§Ã£o para iniciar o processo de assinatura
async def start_subscription(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.message.chat_id

    # Pergunta ao usuÃ¡rio se possui um cupom de desconto
    await context.bot.send_message(chat_id=chat_id, text="VocÃª possui um cupom de desconto? Se sim, envie o cÃ³digo agora, ou digite 'NÃ£o' para continuar sem cupom.")
    context.user_data['awaiting_coupon'] = True

# FunÃ§Ã£o para processar a entrada de um cÃ³digo de cupom ou "NÃ£o"
async def process_coupon(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.message.chat_id
    user_input = update.message.text.strip()

    if context.user_data.get('awaiting_coupon'):
        if user_input.lower() != "nÃ£o":
            if user_input.upper() == VALID_COUPON:
                temp_coupon[chat_id] = VALID_COUPON
                await context.bot.send_message(chat_id=chat_id, text="Cupom 'PROMO50' aplicado! Escolha seu produto.")
            else:
                await context.bot.send_message(chat_id=chat_id, text="Cupom invÃ¡lido. Continuando sem cupom.")
        else:
            await context.bot.send_message(chat_id=chat_id, text="Continuando sem cupom.")

        # Limpa o estado de espera do cupom
        context.user_data['awaiting_coupon'] = False

        # Envia uma mensagem perguntando qual produto o usuÃ¡rio deseja escolher
        keyboard = [
            [InlineKeyboardButton("3 cartas - R$19,90", callback_data='3_cartas')],
            [InlineKeyboardButton("6 cartas - R$24,90", callback_data='6_cartas')],
            [InlineKeyboardButton("3 Perguntas ao OrÃ¡culo - R$29,90", callback_data='3_perguntas_oraculo')],
            [InlineKeyboardButton("12 cartas - R$34,90", callback_data='12_cartas')],
            [InlineKeyboardButton("Tarot do Amor Completo - R$49,90", callback_data='tarot_amor_completo')],
            [InlineKeyboardButton("21 cartas - R$49,90", callback_data='21_cartas')],
            [InlineKeyboardButton("10 Perguntas ao OrÃ¡culo - R$59,90", callback_data='10_perguntas_oraculo')],
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await context.bot.send_message(chat_id=chat_id, text="Escolha seu produto:", reply_markup=reply_markup)

# FunÃ§Ã£o para processar a escolha do plano e redirecionar para o pagamento no Stripe
async def process_plan_selection(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    plan = query.data  # Aqui a variÃ¡vel 'plan' recebe o valor

    # Obter o link correspondente ao plano escolhido
    checkout_url = links_stripe.get(plan)

    # Verificar se o plano foi encontrado
    if checkout_url:
        # Enviar a URL de pagamento para o usuÃ¡rio
        await query.answer()
        await query.edit_message_text(f"Por favor, siga este link para concluir seu pagamento: {checkout_url}")
    else:
        await query.answer()
        await query.edit_message_text("Desculpe, ocorreu um erro ao processar sua solicitaÃ§Ã£o.")

# FunÃ§Ã£o para enviar a leitura de tarot apÃ³s o pagamento
async def send_tarot_reading(update: Update, context: ContextTypes.DEFAULT_TYPE):
    selected_cards = choose_cards(tarot_deck, 3)  # Exemplo: 3 cartas
    interpretation = interpret_cards(selected_cards, tarot_deck)
    chat_id = update.message.chat_id
    await context.bot.send_message(chat_id=chat_id, text=interpretation, parse_mode=ParseMode.HTML)

# ConfiguraÃ§Ã£o do bot
application = Application.builder().token('7231958483:AAHoHfowtwVudXsc15JEfNZHcgh6PnJnAxI').build()

# Adicionar handlers para os comandos
application.add_handler(CommandHandler('assinar', start_subscription))
application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, process_coupon))
application.add_handler(CallbackQueryHandler(process_plan_selection))

# Inicie o bot
if __name__ == "__main__":
    application.run_polling()
